{% extends 'shortener/settings.html' %}
{% load static %}

{% block settings_title %}My Profile{% endblock %}
{% block profile_active %}bg-gray-50 text-primary-700 hover:bg-white hover:text-primary-700{% endblock %}

{% block settings_content %}
<div class="shadow sm:overflow-hidden sm:rounded-md">
    <div class="space-y-6 bg-white dark:bg-gray-800 py-6 px-4 sm:p-6">
        <div>
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">My Profile</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage your account information and security
                settings</p>
        </div>

        <form method="POST">
            {% csrf_token %}
            {% include 'shortener/_form_errors.html' with form=form %}

            <div class="grid grid-cols-1 gap-6">
                <!-- Avatar Section -->
                {% include 'shortener/_avatar_input.html' with avatar_url=form.avatar_url.value|default:request.user.profile.avatar_url|default:'' username=request.user.username initials=request.user.username|slice:':1' fetch_gravatar=True %}

                <div class="col-span-1">
                    <label for="username"
                        class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Username</label>
                    <div class="mt-2">
                        <input type="text" name="username" id="username" value="{{ form.username.value|default:request.user.username }}" required
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                    </div>
                </div>

                <div class="col-span-1">
                    <label for="email" class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Email
                        address</label>
                    <div class="mt-2">
                        <input type="email" name="email" id="email" value="{{ form.email.value|default:request.user.email }}"
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                    </div>
                </div>

                <div class="col-span-1">
                    <label for="member_since"
                        class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Member
                        Since</label>
                    <div class="mt-2">
                        <input type="text" id="member_since"
                            value="{{ request.user.date_joined|date:'F j, Y â€¢ g:i A' }}" disabled
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 sm:text-sm sm:leading-6 cursor-not-allowed">
                    </div>
                </div>

                <div class="border-t border-gray-900/10 dark:border-gray-700 pt-6">
                    <h2 class="text-base font-semibold leading-7 text-gray-900 dark:text-white">Change Password</h2>
                    <p class="mt-1 text-sm leading-6 text-gray-500 dark:text-gray-400">Leave blank to keep your current
                        password</p>

                    <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">
                        <div class="sm:col-span-4">
                            <label for="current_password"
                                class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Current
                                Password</label>
                            <div class="mt-2">
                                <input type="password" name="current_password" id="current_password"
                                    autocomplete="current-password"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div class="sm:col-span-3">
                            <label for="new_password"
                                class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">New
                                Password</label>
                            <div class="mt-2">
                                <input type="password" name="new_password" id="new_password" autocomplete="new-password"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div class="sm:col-span-3">
                            <label for="confirm_password"
                                class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Confirm New
                                Password</label>
                            <div class="mt-2">
                                <input type="password" name="confirm_password" id="confirm_password"
                                    autocomplete="new-password"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="bg-gray-50 dark:bg-gray-700/50 px-4 py-3 text-right sm:px-6 -mx-4 -mb-6 mt-6 sm:-mx-6 sm:-mb-6 rounded-b-md">
                <a href="{% url 'dashboard' %}"
                    class="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white mr-4">Cancel</a>
                <button type="submit"
                    class="inline-flex justify-center rounded-md bg-primary-600 py-2 px-3 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('fetch-gravatar-btn').addEventListener('click', function () {
        const emailInput = document.getElementById('email');
        const avatarInput = document.getElementById('avatar_url');
        const email = emailInput.value.trim().toLowerCase();

        if (!email) {
            alert('Please enter an email address first.');
            return;
        }

        if (typeof md5 === 'undefined') {
            console.error('MD5 library not loaded');
            return;
        }

        const hash = md5(email);
        const gravatarUrl = `https://www.gravatar.com/avatar/${hash}?s=200`;

        avatarInput.value = gravatarUrl;

        // Trigger preview update manually (scope to profile preview only)
        const previewImg = document.getElementById('profile-avatar-img');
        const previewInitials = document.getElementById('profile-avatar-initials');
        if (previewImg && previewInitials) {
            if (typeof previewImg.updateAvatarPreview === 'function') {
                previewImg.updateAvatarPreview(gravatarUrl);
            } else {
                previewImg.src = gravatarUrl;
            }
            // Show image, hide initials
            previewImg.classList.remove('hidden');
            previewInitials.classList.add('hidden');
        }
    });

    // Helper: generate inline SVG data URI for initials (small, deterministic)
    function initialsDataUri(initial, size = 120, bg = '#6366f1', fg = '#ffffff') {
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><rect width='100%25' height='100%25' fill='${bg}'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='${Math.round(size/2.5)}' fill='${fg}'>${initial}</text></svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }

    document.getElementById('avatar_url').addEventListener('input', function (e) {
        const val = e.target.value.trim();
        const previewImg = document.getElementById('profile-avatar-img');
        const previewInitials = document.getElementById('profile-avatar-initials');
        if (!previewImg || !previewInitials) return;

        if (typeof previewImg.updateAvatarPreview === 'function') {
            // Let custom preview handler manage it
            previewImg.updateAvatarPreview(val || null);
            return;
        }

        if (val) {
            previewImg.src = val;
            previewImg.classList.remove('hidden');
            previewInitials.classList.add('hidden');
        } else {
            // No URL: hide image and show initials div
            previewImg.src = '';
            previewImg.classList.add('hidden');
            previewInitials.classList.remove('hidden');
        }
    });

    // If the profile preview img doesn't have updateAvatarPreview (global loader not attached),
    // attach a local validator so the preview only applies valid images.
    (function attachLocalPreviewValidator() {
         const previewImg = document.getElementById('profile-avatar-img');
         const previewInitials = document.getElementById('profile-avatar-initials');
         if (!previewImg || !previewInitials) return;
         if (typeof previewImg.updateAvatarPreview === 'function') return;

         previewImg.updateAvatarPreview = function (url) {
             const u = (url || '').trim();
             if (!u) {
                previewImg.src = '';
                previewImg.classList.add('hidden');
                previewInitials.classList.remove('hidden');
                return;
             }

             const tmp = new Image();
             let done = false;
             const tto = setTimeout(() => {
                if (!done) {
                   done = true;
                   previewImg.src = '';
                   previewImg.classList.add('hidden');
                   previewInitials.classList.remove('hidden');
                }
             }, 3000);

             tmp.onload = function () {
                if (done) return;
                if (!tmp.naturalWidth || !tmp.naturalHeight) {
                   done = true;
                   clearTimeout(tto);
                   previewImg.src = '';
                   previewImg.classList.add('hidden');
                   previewInitials.classList.remove('hidden');
                   return;
                }
                done = true;
                clearTimeout(tto);
                previewImg.src = u;
                previewImg.classList.remove('hidden');
                previewInitials.classList.add('hidden');
             };
             tmp.onerror = function () {
                if (done) return;
                done = true;
                clearTimeout(tto);
                previewImg.src = '';
                previewImg.classList.add('hidden');
                previewInitials.classList.remove('hidden');
             };
             tmp.src = u;
         };

        // If there is an existing data-avatar-url (stored profile avatar), validate & apply it now
        const existing = (previewImg.getAttribute('data-avatar-url') || '').trim();
        if (existing) {
            // Run async so DOM is ready and validator is attached
            setTimeout(() => {
                try {
                    previewImg.updateAvatarPreview(existing);
                } catch (e) { /* ignore */ }
            }, 0);
        }
    })();
</script>
{% endblock %}

{% block settings_scripts %}
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>
{% endblock %}