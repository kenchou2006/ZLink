{% extends 'shortener/settings.html' %}
{% load static %}

{% block settings_title %}My Profile{% endblock %}
{% block profile_active %}bg-gray-50 text-primary-700 hover:bg-white hover:text-primary-700{% endblock %}

{% block settings_content %}
<div class="shadow sm:overflow-hidden sm:rounded-md">
    <div class="space-y-6 bg-white dark:bg-gray-800 py-6 px-4 sm:p-6">
        <div>
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">My Profile</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage your account information and security
                settings</p>
        </div>

        <form method="POST">
            {% csrf_token %}

            <div class="grid grid-cols-1 gap-6">
                <!-- Avatar Section -->
                <div class="col-span-1">
                    <label for="avatar_url" class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Profile
                        Picture</label>
                    <div class="mt-2 flex items-center gap-x-3">
                        <img class="user-avatar-img h-12 w-12 rounded-full object-cover text-gray-300"
                            data-avatar-url="{{ request.user.profile.avatar_url|default:'' }}"
                            data-username="{{ request.user.username|slice:':1'|upper }}"
                            alt="{{ request.user.username }}"
                            src="{% if request.user.profile.avatar_url %}{{ request.user.profile.avatar_url }}{% else %}https://ui-avatars.com/api/?name={{ request.user.username }}&background=6366f1&color=fff{% endif %}">

                        <div class="flex-1">
                            <div
                                class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 focus-within:ring-2 focus-within:ring-inset focus-within:ring-primary-600 sm:max-w-md">
                                <input type="url" name="avatar_url" id="avatar_url"
                                    value="{{ request.user.profile.avatar_url|default:'' }}"
                                    class="block w-full flex-1 border-0 bg-transparent py-1.5 pl-3 px-3 text-gray-900 dark:text-white placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6"
                                    placeholder="https://avatars.githubusercontent.com/u/27804">
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Enter an image URL or fetch from
                                Gravatar</p>
                        </div>

                        <button type="button" id="fetch-gravatar-btn"
                            class="rounded-md bg-white dark:bg-gray-700 px-2.5 py-1.5 text-sm font-semibold text-gray-900 dark:text-white shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600">
                            Fetch from Gravatar
                        </button>
                    </div>
                </div>

                <div class="col-span-1">
                    <label for="username"
                        class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Username</label>
                    <div class="mt-2">
                        <input type="text" name="username" id="username" value="{{ request.user.username }}" required
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                    </div>
                </div>

                <div class="col-span-1">
                    <label for="email" class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Email
                        address</label>
                    <div class="mt-2">
                        <input type="email" name="email" id="email" value="{{ request.user.email }}"
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                    </div>
                </div>

                <div class="col-span-1">
                    <label for="member_since"
                        class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Member
                        Since</label>
                    <div class="mt-2">
                        <input type="text" id="member_since"
                            value="{{ request.user.date_joined|date:'F j, Y â€¢ g:i A' }}" disabled
                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 sm:text-sm sm:leading-6 cursor-not-allowed">
                    </div>
                </div>

                <div class="border-t border-gray-900/10 dark:border-gray-700 pt-6">
                    <h2 class="text-base font-semibold leading-7 text-gray-900 dark:text-white">Change Password</h2>
                    <p class="mt-1 text-sm leading-6 text-gray-500 dark:text-gray-400">Leave blank to keep your current
                        password</p>

                    <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">
                        <div class="sm:col-span-4">
                            <label for="current_password"
                                class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Current
                                Password</label>
                            <div class="mt-2">
                                <input type="password" name="current_password" id="current_password"
                                    autocomplete="current-password"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div class="sm:col-span-3">
                            <label for="new_password"
                                class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">New
                                Password</label>
                            <div class="mt-2">
                                <input type="password" name="new_password" id="new_password" autocomplete="new-password"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>

                        <div class="sm:col-span-3">
                            <label for="confirm_password"
                                class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">Confirm New
                                Password</label>
                            <div class="mt-2">
                                <input type="password" name="confirm_password" id="confirm_password"
                                    autocomplete="new-password"
                                    class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 dark:border-gray-600 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="bg-gray-50 dark:bg-gray-700/50 px-4 py-3 text-right sm:px-6 -mx-4 -mb-6 mt-6 sm:-mx-6 sm:-mb-6 rounded-b-md">
                <a href="{% url 'dashboard' %}"
                    class="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white mr-4">Cancel</a>
                <button type="submit"
                    class="inline-flex justify-center rounded-md bg-primary-600 py-2 px-3 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('fetch-gravatar-btn').addEventListener('click', function () {
        const emailInput = document.getElementById('email');
        const avatarInput = document.getElementById('avatar_url');
        const email = emailInput.value.trim().toLowerCase();

        if (!email) {
            alert('Please enter an email address first.');
            return;
        }

        if (typeof md5 === 'undefined') {
            console.error('MD5 library not loaded');
            return;
        }

        const hash = md5(email);
        const gravatarUrl = `https://www.gravatar.com/avatar/${hash}?s=200`;

        avatarInput.value = gravatarUrl;

        // Trigger preview update manually
        const previewImg = document.querySelector('.user-avatar-img');
        if (previewImg) {
            if (typeof previewImg.updateAvatarPreview === 'function') {
                previewImg.updateAvatarPreview(gravatarUrl);
            } else {
                previewImg.src = gravatarUrl;
            }
        }
    });

    // Live preview update on input change
    document.getElementById('avatar_url').addEventListener('input', function (e) {
        const val = e.target.value.trim();
        const previewImg = document.querySelector('.user-avatar-img');
        if (previewImg) {
            if (typeof previewImg.updateAvatarPreview === 'function') {
                // empty value -> revert to ui-avatar
                previewImg.updateAvatarPreview(val || null);
            } else {
                if (val) previewImg.src = val;
            }
        }
    });
</script>
{% endblock %}

{% block settings_scripts %}
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.19.0/js/md5.min.js"></script>
{% endblock %}